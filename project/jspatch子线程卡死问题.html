<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>JSPatch å­çº¿ç¨‹è°ƒç”¨å¡æ­»é—®é¢˜</title>

</head>
<body>
<h3>JSPatch å­çº¿ç¨‹è°ƒç”¨å¡æ­»é—®é¢˜</h3>

<h4>é—®é¢˜æè¿°</h4>

<p>ç”¨JSPatchä¿®å¤äº†ä¸€ä¸ªä¸»æµç¨‹æ¨¡å—çš„äº‹ä»¶ç‚¹å‡»å‡½æ•°ï¼Œåœ¨è¿™ä¸ªäº‹ä»¶ä¸­ï¼ŒåŒ…å«äº†ç½‘ç»œè¯·æ±‚ï¼ˆä¸æ­¢ä¸€ä¸ªï¼Œè¿ç»­å¤šä¸ªè¯·æ±‚ï¼‰ã€‚åŒ…ä¸Šçº¿äº†ä¹‹åï¼ŒæˆåŠŸçš„è§£å†³äº†çº¿ä¸Šçš„Bugã€‚ä½†æ˜¯ï¼Œè¿‡äº†ä¸€å¤©åï¼Œæœ‰åŒå­¦å‘ç°åœ¨ios7ç³»ç»Ÿä¸‹çš„ä¸»æ¨¡å—å…¥å£è¿›ä¸å»äº†ï¼Œæ­£å¥½æ˜¯ä¸Šæ¬¡ä¿®å¤çš„bug,ğŸ˜±ï¼</p>

<h4>ç ”ç©¶é—®é¢˜</h4>

<p>å¼€å‘åŒå­¦ç»„ç»‡èµ·æ¥å‡†å¤‡æ‹¯æ•‘ä¸–ç•Œï¼Œé—®é¢˜ä¸€ç‚¹ç‚¹çš„è¢«æŒ–æ˜å‡ºæ¥ã€‚</p>

<ul>
<li><p>æ¶‰åŠç³»ç»Ÿios7</p></li>
<li><p>æ¶‰åŠç‰ˆæœ¬xxx</p></li>
<li><p>å¥”æºƒæ¿€å¢åœ¨æŸä¸€JSPatchå‘ç‰ˆåï¼ˆåœ¨æˆ‘ä»¬ä¿®å¤äº†bugä¹‹åï¼Œæœ‰äººåˆå‘äº†ä¸€ç‰ˆï¼‰</p></li>
</ul>


<p>ä¼šä¸ä¼šæ˜¯åä¿®å¤çš„æ–‡ä»¶å¼•èµ·çš„é—®é¢˜ï¼Ÿåˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œæœç„¶ç”Ÿæ•ˆã€‚</p>

<h4>è§£å†³é—®é¢˜</h4>

<p>åˆ é™¤ä¹‹åä¿®å¤çš„æ–‡ä»¶ï¼Œå‘å¸ƒJSPatchåˆ°çº¿ä¸Šï¼Œè¿™ä¸ªé—®é¢˜è§£å†³äº†ã€‚</p>

<h4>åæœŸè·Ÿè¸ª</h4>

<p>bugæ˜¯è§£å†³äº†ï¼Œä½†æ˜¯çœŸæ­£çš„åŸå› è¿˜æ˜¯æ²¡æœ‰åˆ†æå‡ºæ¥ã€‚ç»è¿‡åæœŸçš„è¿½è¸ªï¼Œç»ˆäºæ‰¾åˆ°äº†é—®é¢˜çš„å…³é”®æ‰€åœ¨ã€‚è¿™é‡Œç»™å‡ºä¸€ä¸ª<a href="https://github.com/chieryw/TestJSPatchCase">Demo</a>ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½éªŒè¯ã€‚å›åˆ°å‰–æé—®é¢˜çš„è¯é¢˜ï¼Œå½“æ—¶æˆ‘ä»¬ä¿®å¤äº†ä¸€ä¸ªä¸»æµç¨‹çš„ç‚¹å‡»äº‹ä»¶çš„bug,è¿™ä¸ªç‚¹å‡»äº‹ä»¶æ˜¯ä¼šè§¦å‘å¤šä¸ªç½‘ç»œè¯·æ±‚çš„ã€‚ä¹‹åä¿®å¤çš„bugï¼Œå°±æ˜¯å’Œè¿™ä¸ªç½‘ç»œè¯·æ±‚æœ‰å…³ã€‚</p>

<p><img src="../images/testProtocol.h.png" alt="ä¹‹åbugçš„å›¾ç‰‡" /></p>

<p><img src="../images/testProtocol.h.png" alt="ä¹‹åbugçš„å›¾ç‰‡" /></p>

<p>ä¿®å¤äº†ç»§æ‰¿è‡ªNSURLProtocolçš„+(BOOL)canInitWithRequest:(NSURLRequest *)requestæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•çš„è§¦å‘æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ</p>

<ul>
<li>NSURLConnectionçš„è¯·æ±‚éƒ½ä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•ä¸­å»</li>
</ul>


<p>ç°åœ¨ï¼ŒJSPatchä¿®å¤çš„æ–¹æ³•ç‚¹å‡»ä¹‹ååˆè¿›å…¥äº†JSPatchçš„æ–¹æ³•ä¸­äº†ï¼Œè¿™é‡Œå¤§å®¶éœ€è¦äº†è§£ä¸€ä¸‹<a href="https://github.com/bang590/JSPatch/wiki/performSelectorInOC-%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3">JSPatchæ‰§è¡Œçš„çº¿ç¨‹é—®é¢˜</a>ã€‚ä¸»è¦çœ‹è¿™ä¹ˆä¸€å¥</p>

<pre><code>JavaScript è¯­è¨€æ˜¯å•çº¿ç¨‹çš„ï¼Œåœ¨ OC ä½¿ç”¨ JavaScriptCore å¼•æ“æ‰§è¡Œ JS ä»£ç æ—¶ï¼Œä¼šå¯¹ JS ä»£ç å—åŠ é”ï¼Œä¿è¯åŒä¸ª JSContext ä¸‹çš„ JS ä»£ç éƒ½æ˜¯é¡ºåºæ‰§è¡Œã€‚æ‰€ä»¥ä½¿ç”¨ JSPatch æ›¿æ¢çš„æ–¹æ³•éƒ½ä¼šåœ¨è¿™ä¸ªé”é‡Œæ‰§è¡Œï¼Œæ— æ³•å¹¶è¡Œæ‰§è¡Œï¼Œè¿™å¯¼è‡´å¦‚æœä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹åŒæ—¶è¿è¡Œäº† JSPatch æ›¿æ¢çš„æ–¹æ³•ï¼Œå­çº¿ç¨‹å°±ä¼šå¡ä½ä¸»çº¿ç¨‹ã€‚
</code></pre>

<p>å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªå…¶å®æˆ‘ä»¬å¯ä»¥å˜æ¢ä¸€ä¸‹æ€è·¯ï¼Œåœ¨ä¹‹å‰æä¾›çš„<a href="https://github.com/chieryw/TestJSPatchCase">demoå·¥ç¨‹ä¸­</a>,ä¸ç›´æ¥ä¿®å¤<code>canInitWithRequest</code>æ–¹æ³•ï¼Œå…ˆåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ‰“å°å½“å‰çš„çº¿ç¨‹ï¼Œå†åœ¨JSä¸­æ‰§è¡ŒtempSelectoræ–¹æ³•è¿”å›ï¼Œæ›´æ”¹çš„åœ°æ–¹æœ‰</p>

<pre><code>OC:
+ (BOOL)canInitWithRequest:(NSURLRequest *)request {
    NSLog(@"å½“å‰çº¿ç¨‹ï¼š%@",[NSThread currentThread]);
    return [self tempSelector];
}

+ (BOOL)tempSelector {
    // è¿™ä¸ªæ–¹æ³•å°†åœ¨JSä¸­ä¿®å¤
    return YES;
}

JS:ç›´æ¥æ›¿æ¢TestProtocol.jså†…å®¹ä¸º

defineClass('TestProtocol', {}, {
    tempSelector: function() {
        console.log('å½“å‰çº¿ç¨‹');
        console.log(require('NSThread').currentThread())
        console.log('èµ°äº†JSä¿®å¤çš„protocolæ–¹æ³•');
        return true;
},
</code></pre>

<p>})</p>

<p>ios7æ—¥å¿—å›¾ç‰‡</p>

<p><img src="../images/ios7Log.png" alt="ios7Logå›¾ç‰‡" /></p>

<p>æ ¹æ®æ—¥å¿—ï¼Œæˆ‘ä»¬é¢„æµ‹äº†ios7ä¸Šçš„JSPatchçš„æ‰§è¡Œçº¿ç¨‹ä¸ºï¼š</p>

<p><img src="../images/ios7Thread.png" alt="çº¿ç¨‹æ‰§è¡Œçš„æµç¨‹" /></p>

<p>ios8,ios9ä¸ä¼šå¥”æºƒï¼Œæˆ‘ä»¬æ‰“å°äº†ç›¸åº”çš„logä»æ—¥å¿—åˆ†æä¸­ï¼Œæˆ‘ä»¬ä¼šè¯»åˆ°æƒ³è¦çš„ä¿¡æ¯</p>

<p>ios9æ—¥å¿—å›¾ç‰‡</p>

<p><img src="../images/ios9Log.png" alt="ios9Logå›¾ç‰‡" /></p>

<p>ä»æ—¥å¿—ä¸­å¾—å‡ºios9ä¸Šçš„æ‰§è¡Œé¡ºåºæœ‰äº†å˜åŒ–</p>

<p><img src="../images/ios9Thread.png" alt="çº¿ç¨‹æ‰§è¡Œçš„æµç¨‹" /></p>

<p>åŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œios7ä¸Šä¿®å¤çš„JSPatchï¼Œä¼šå¹¶è¡Œæ‰§è¡Œã€‚ios8ã€9ä¸Šåˆ™æ˜¯é¡ºåºæ‰§è¡Œã€‚çœ‹æ¥cpuåœ¨å¯¹JSCoreæ“ä½œåˆ†é…é¡ºåºä¸Šios7å’Œios8ã€9å­˜åœ¨äº†å¾ˆå¤§çš„åŒºåˆ«ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨ios8/9ä¸Šæ²¡æœ‰å­˜åœ¨å­çº¿ç¨‹å¡æ­»ä¸»çº¿ç¨‹çš„æƒ…å†µã€‚</p>
</body>
</html>